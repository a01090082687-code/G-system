<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Immunity War | G-SYSTEM</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background: linear-gradient(180deg, #E0F7FA 0%, #80DEEA 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            touch-action: none;
            -webkit-tap-highlight-color: transparent;
        }
        .wrap {
            width: 100%;
            max-width: 430px;
            height: 100vh;
            max-height: 820px;
            position: relative;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 0 40px rgba(0,0,0,0.6);
        }
        #c {
            display: block;
            width: 100%;
            height: 100%;
            background: linear-gradient(180deg, #E0F7FA 0%, #80DEEA 100%);
        }
        .hud {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            padding: 14px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            pointer-events: none;
            z-index: 5;
        }
        .hud span { color: #333333; font-size: 16px; font-weight: bold; font-family: sans-serif; text-shadow: 0 0 2px rgba(255,255,255,0.8); }
        .power-up-msg {
            position: absolute;
            left: 50%;
            top: 35%;
            transform: translate(-50%, -50%);
            font-size: 28px;
            font-weight: bold;
            color: #38bdf8;
            text-shadow: 0 0 20px rgba(56, 189, 248, 0.8);
            pointer-events: none;
            z-index: 15;
            opacity: 0;
            transition: opacity 0.1s;
        }
        .power-up-msg.show {
            animation: powerUpFade 1.2s ease-out forwards;
        }
        .power-up-msg.gold {
            color: #fbbf24;
            text-shadow: 0 0 24px rgba(251, 191, 36, 0.9);
            font-size: 32px;
        }
        @keyframes powerUpFade {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
            20% { opacity: 1; transform: translate(-50%, -50%) scale(1.2); }
            80% { opacity: 1; }
            100% { opacity: 0; transform: translate(-50%, -60%) scale(1); }
        }
        .flash {
            position: absolute;
            inset: 0;
            background: rgba(56, 189, 248, 0.25);
            pointer-events: none;
            z-index: 12;
            opacity: 0;
        }
        .flash.on {
            animation: flashFade 0.35s ease-out forwards;
        }
        .flash.gold {
            background: rgba(251, 191, 36, 0.35);
        }
        @keyframes flashFade {
            0% { opacity: 1; }
            100% { opacity: 0; }
        }
        .start-screen {
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, 0.75);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 20;
            padding: 24px;
        }
        .start-screen.hide { display: none; }
        .start-title { color: #ffffff; font-size: 24px; margin-bottom: 12px; text-align: center; }
        .start-desc { color: rgba(255, 255, 255, 0.95); font-size: 14px; line-height: 1.6; text-align: center; margin-bottom: 24px; }
        .btn { background: linear-gradient(135deg, #0ea5e9, #06b6d4); color: #fff; border: none; padding: 14px 36px; border-radius: 12px; font-size: 18px; font-weight: bold; cursor: pointer; }
        .version-info { color: rgba(255, 255, 255, 0.7); font-size: 12px; margin-top: 14px; }
        .version-info.version-title { margin-top: 6px; margin-bottom: 8px; font-size: 14px; color: rgba(255, 255, 255, 0.95); }
        .go-screen {
            position: absolute;
            inset: 0;
            background: rgba(255, 255, 255, 0.96);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 20;
            padding: 24px;
        }
        .go-screen.show { display: flex; }
        .go-title { color: #333333; font-size: 26px; margin-bottom: 8px; font-weight: bold; }
        .go-score { color: #333333; font-size: 22px; margin-bottom: 20px; font-weight: bold; }
        .rank-box { width: 100%; max-width: 320px; background: rgba(255,255,255,0.95); border-radius: 12px; padding: 16px; margin-bottom: 16px; max-height: 200px; overflow-y: auto; color: #333333; border: 1px solid rgba(0,0,0,0.1); }
        .rank-row { display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid rgba(0,0,0,0.1); font-size: 14px; color: #333333; }
        .rank-row:last-child { border-bottom: none; }
        .go-inp { width: 100%; max-width: 320px; padding: 12px; margin-bottom: 10px; border: 2px solid rgba(0,0,0,0.2); border-radius: 10px; font-size: 16px; text-align: center; background: #fff; color: #333333; }
        .go-inp:focus { outline: none; border-color: #0ea5e9; }
        .btn-submit { width: 100%; max-width: 320px; margin-bottom: 10px; }
    </style>
</head>
<body>
    <div class="wrap">
        <canvas id="c"></canvas>
        <div class="flash" id="flash"></div>
        <div class="power-up-msg" id="powerUpMsg">Power UP!</div>
        <div class="hud">
            <span>Ï†êÏàò: <span id="scoreEl">0</span> ¬∑ Ïõ®Ïù¥Î∏å <span id="waveEl">1</span></span>
            <span>Ï£ºÏÇ¨Í∏∞: <span id="fireEl">1</span></span>
        </div>
        <div class="start-screen" id="startScreen">
            <div class="start-title">üõ°Ô∏è Immunity War</div>
            <div class="version-info version-title">Ver 4.0 (Final Polished)</div>
            <div class="start-desc">Ï¢åÏö∞ ÎìúÎûòÍ∑∏Î°ú Ïù¥Îèô. üü¶ Ï¢ãÏùÄ Î¨∏=Ï¥ùÏïå ÏòÅÍµ¨ Ï¶ùÍ∞Ä ¬∑ üü• ÎÇòÏÅú Î¨∏/Ï†Å Ï†ëÏ¥â=Ï¥ùÏïå Í∞êÏÜå<br>üì¶ Î≥¥Í∏âÏÉÅÏûê=Ï¥ùÏïå+3 ¬∑ üëπ Î≥¥Ïä§ Ï≤òÏπò ÌõÑ üëë Ìô©Í∏à Í≤åÏù¥Ìä∏!</div>
            <button class="btn" id="btnStart">Í≤åÏûÑ ÏãúÏûë</button>
        </div>
        <div class="go-screen" id="goScreen">
            <div class="go-title">Í≤åÏûÑ Ïò§Î≤Ñ</div>
            <div class="go-score">Ï†êÏàò: <span id="finalScore">0</span></div>
            <div class="rank-box" id="rankList">Î°úÎî© Ï§ë...</div>
            <input type="text" class="go-inp" id="playerName" placeholder="Ïù¥Î¶Ñ (ÏµúÎåÄ 10Ïûê)" maxlength="10">
            <button class="btn btn-submit" id="btnSubmit">Îû≠ÌÇπ Îì±Î°ù</button>
            <button class="btn" id="btnRetry">Îã§Ïãú ÌïòÍ∏∞</button>
        </div>
    </div>

    <script>
    (function() {
        'use strict';

        var GAS_URL = 'https://script.google.com/macros/s/AKfycbxKQ7DSfpBhiBE3JOSam39bvs8argQaf0s6hQJIMpH5l5knJKVfEfcW3lpCTODjLBMkiw/exec';

        var canvas = document.getElementById('c');
        var ctx = canvas.getContext('2d');
        var cw, ch;
        function resize() {
            var w = canvas.parentElement.clientWidth;
            var h = canvas.parentElement.clientHeight;
            cw = w;
            ch = h;
            canvas.width = w;
            canvas.height = h;
        }
        window.addEventListener('resize', resize);
        resize();

        var FPS = 60;
        let animationId = null;
        var Gupaengi = 'üêß';
        var state = {
            run: false,
            score: 0,
            wave: 1,
            gameTime: 0,
            difficultyScale: 0.2,
            px: 0.5,
            playerW: 52,
            playerH: 48,
            fireCount: 1,
            fireInterval: 10,
            fireTick: 0,
            syringes: [],
            enemies: [],
            gates: [],
            particles: [],
            damageNumbers: [],
            boxes: [],
            boss: null,
            shakeTime: 0,
            shakeMag: 0,
            spawnEnemy: 0,
            spawnGate: 0,
            spawnBox: 0
        };

        var SYR_W = 14, SYR_H = 24, SYR_VY = -11;
        var GATE_W_RATIO = 0.22, GATE_H = 56, GATE_VY = 1.6, GATE_GAP = 0.06;
        var ENEMY_SPAWN_BASE = 16, GATE_SPAWN = 1280, BOX_SPAWN = 400;
        var SPEED_MULT = 1.3;
        var PLAYER_BOTTOM_MARGIN = 0.15;
        var HITBOX_SCALE = 0.6;
        var BOSS_HP_BASE = 80;
        var WAVE_BOSS_EVERY = 5;
        var DIFFICULTY_INTERVAL = 30 * FPS; // 30Ï¥à

        var goodLabelsAdd = [{ label: 'Ïö¥Îèô +1', add: 1 }, { label: 'ÏàòÎ©¥ +2', add: 2 }, { label: 'Î¨º ÏÑ≠Ï∑® +1', add: 1 }, { label: 'ÎπÑÌÉÄÎØº +2', add: 2 }, { label: 'Ìú¥Ïãù +1', add: 1 }];
        var goodLabelsMult = [{ label: 'ÎπÑÌÉÄÎØº ÏÑ≠Ï∑® x2', mult: 2 }, { label: 'ÏàòÎ©¥ x3', mult: 3 }];
        var badLabels = ['ÏùåÏ£º √∑2', 'Ìù°Ïó∞ -10', 'Í≥ºÎ°ú √∑2'];

        function screenShake(magnitude, duration) {
            state.shakeMag = Math.max(state.shakeMag, magnitude);
            state.shakeTime = Math.max(state.shakeTime, duration || 15);
        }

        function addDamageNumber(x, y, value, isCrit) {
            state.damageNumbers.push({
                x: x + (Math.random() - 0.5) * 20,
                y: y,
                val: value,
                crit: !!isCrit,
                life: 1,
                vy: -3
            });
        }

        function addParticles(x, y, color, count, scale) {
            count = count || 14;
            scale = scale || 1;
            for (var i = 0; i < count; i++) {
                var a = (Math.PI * 2 * i) / count + Math.random();
                var v = (3 + Math.random() * 4) * scale;
                state.particles.push({
                    x: x, y: y,
                    vx: Math.cos(a) * v,
                    vy: Math.sin(a) * v - 2 * scale,
                    life: 1,
                    color: color,
                    r: (4 + Math.random() * 4) * scale
                });
            }
        }

        function addBossExplosion(x, y) {
            addParticles(x, y, '#fbbf24', 28, 1.8);
            addParticles(x, y, '#f87171', 20, 1.2);
            screenShake(12, 25);
        }

        function addSyringe() {
            var baseX = state.px * cw;
            var count = state.fireCount;
            var py = ch * (1 - PLAYER_BOTTOM_MARGIN) - state.playerH;
            var spread = (count * 8) / 2;
            for (var i = 0; i < count; i++) {
                var angle = count === 1 ? 0 : (i - (count - 1) / 2) * 6;
                var rad = (angle * Math.PI) / 180;
                state.syringes.push({
                    x: baseX - SYR_W / 2 + Math.sin(rad) * 20,
                    y: py + state.playerH - 10,
                    w: SYR_W,
                    h: SYR_H,
                    vy: SYR_VY * Math.cos(rad),
                    vx: Math.sin(rad) * 4,
                    giant: false,
                    piercing: false
                });
            }
        }

        function addEnemy() {
            var type = Math.random() > 0.5 ? 'ü¶†' : 'üòà';
            var r = 16 + Math.random() * 10;
            var baseHp = Math.max(1, Math.floor((1 + r / 12) * state.difficultyScale));
            var hp = Math.max(2, baseHp * 2);
            var vy = (0.8 + Math.random() * 0.6) * state.difficultyScale * SPEED_MULT;
            var x = cw * 0.1 + Math.random() * (cw * 0.8);
            state.enemies.push({
                x: x,
                y: -r * 2,
                r: r,
                hp: hp,
                maxHp: hp,
                vy: vy,
                type: type
            });
        }

        function addBoss() {
            var type = Math.random() > 0.5 ? '‚ò†Ô∏è' : 'üëπ';
            var r = 52;
            var hp = Math.floor(BOSS_HP_BASE * state.difficultyScale);
            state.boss = {
                x: cw / 2,
                y: -r - 20,
                r: r,
                hp: hp,
                maxHp: hp,
                vy: 1.2 * state.difficultyScale * SPEED_MULT,
                type: type
            };
        }

        function addGoldenGate() {
            var gw = cw * 0.35;
            var x = cw * 0.1 + Math.random() * (cw * 0.8 - gw);
            state.gates.push({
                x: x,
                y: -GATE_H,
                w: gw,
                h: GATE_H,
                vy: GATE_VY * state.difficultyScale * SPEED_MULT,
                good: true,
                gold: true,
                label: 'üëë ÏäàÌçº Î©¥Ïó≠ x5'
            });
        }

        function pickGoodGate() {
            if (Math.random() < 0.1) {
                var o = goodLabelsMult[Math.floor(Math.random() * goodLabelsMult.length)];
                return { label: o.label, addBonus: 0, multBonus: o.mult };
            }
            var o = goodLabelsAdd[Math.floor(Math.random() * goodLabelsAdd.length)];
            return { label: o.label, addBonus: o.add, multBonus: 0 };
        }
        function addGates() {
            var good = Math.random() > 0.5;
            var gw = cw * GATE_W_RATIO;
            var gateVy = GATE_VY * state.difficultyScale * SPEED_MULT;
            var zoneW = cw * 0.8 - gw;
            var x1 = cw * 0.1 + Math.random() * zoneW;
            var x2 = cw * 0.1 + Math.random() * zoneW;
            if (Math.abs(x1 - x2) < gw) x2 = x1 + gw + Math.random() * (zoneW - gw);
            if (x2 > cw * 0.9 - gw) x2 = cw * 0.9 - gw;
            var g1 = good ? pickGoodGate() : { label: badLabels[Math.floor(Math.random() * badLabels.length)], addBonus: 0, multBonus: 0 };
            var g2 = good ? { label: badLabels[Math.floor(Math.random() * badLabels.length)], addBonus: 0, multBonus: 0 } : pickGoodGate();
            state.gates.push(
                { x: x1, y: -GATE_H, w: gw, h: GATE_H, vy: gateVy, good: good, label: g1.label, addBonus: g1.addBonus, multBonus: g1.multBonus },
                { x: x2, y: -GATE_H, w: gw, h: GATE_H, vy: gateVy, good: !good, label: g2.label, addBonus: g2.addBonus, multBonus: g2.multBonus }
            );
        }

        function addBox() {
            var type = Math.random() > 0.5 ? 'üì¶' : 'üöß';
            var w = 48 + Math.random() * 20;
            var h = 40 + Math.random() * 14;
            var hp = 12 + Math.floor(Math.random() * 12);
            var x = cw * 0.1 + Math.random() * (cw * 0.8 - w);
            state.boxes.push({
                x: x,
                y: -h - 20,
                w: w,
                h: h,
                hp: hp,
                maxHp: hp,
                vy: 1.4 * state.difficultyScale * SPEED_MULT,
                type: type
            });
        }

        function dropWeaponUpgrade(x, y) {
            state.fireCount = Math.min(99, state.fireCount + 3);
            addParticles(x, y, '#38bdf8', 16, 1.2);
            screenShake(6, 12);
        }

        canvas.addEventListener('touchstart', function(e) { e.preventDefault(); }, { passive: false });
        canvas.addEventListener('touchmove', function(e) {
            e.preventDefault();
            if (!state.run) return;
            var rect = canvas.getBoundingClientRect();
            var tx = (e.touches[0].clientX - rect.left) / rect.width;
            state.px = Math.max(0.08, Math.min(0.92, tx));
        }, { passive: false });

        var md = false;
        canvas.addEventListener('mousedown', function(e) {
            if (!state.run) return;
            md = true;
        });
        canvas.addEventListener('mousemove', function(e) {
            if (!md || !state.run) return;
            var rect = canvas.getBoundingClientRect();
            var mx = (e.clientX - rect.left) / rect.width;
            state.px = Math.max(0.08, Math.min(0.92, mx));
        });
        canvas.addEventListener('mouseup', function() { md = false; });
        canvas.addEventListener('mouseleave', function() { md = false; });

        function hitBulletEnemy(b, e) {
            var bx = b.x + b.w / 2, by = b.y + b.h / 2;
            var dx = bx - e.x, dy = by - e.y;
            var r = (e.r || 20);
            return dx * dx + dy * dy < r * r;
        }

        function hitBulletBox(b, box) {
            var bx = b.x + b.w / 2, by = b.y + b.h / 2;
            return bx >= box.x && bx <= box.x + box.w && by >= box.y && by <= box.y + box.h;
        }

        function getPlayerHitbox() {
            var py = ch * (1 - PLAYER_BOTTOM_MARGIN) - state.playerH;
            var cx = state.px * cw;
            var cy = py + state.playerH / 2;
            var hw = state.playerW * HITBOX_SCALE / 2;
            var hh = state.playerH * HITBOX_SCALE / 2;
            return { left: cx - hw, right: cx + hw, top: cy - hh, bottom: cy + hh };
        }
        function hitPlayerGate(g) {
            var h = getPlayerHitbox();
            var gb = g.y + g.h;
            var gt = g.y;
            if (gb < h.top) return false;
            if (gt > h.bottom) return false;
            if (h.right < g.x || h.left > g.x + g.w) return false;
            return true;
        }

        function loop() {
            if (!state.run) {
                animationId = requestAnimationFrame(loop);
                return;
            }

            state.gameTime++;
            if (state.gameTime > 30 * FPS && state.gameTime % DIFFICULTY_INTERVAL === 0)
                state.difficultyScale = Math.min(3, state.difficultyScale + 0.1);

            var shakeX = 0, shakeY = 0;
            if (state.shakeTime > 0) {
                state.shakeTime--;
                shakeX = (Math.random() - 0.5) * 2 * state.shakeMag;
                shakeY = (Math.random() - 0.5) * 2 * state.shakeMag;
                if (state.shakeTime <= 0) state.shakeMag = 0;
            }

            ctx.save();
            ctx.translate(shakeX, shakeY);

            var bgGrad = ctx.createLinearGradient(0, 0, 0, ch);
            bgGrad.addColorStop(0, '#E0F7FA');
            bgGrad.addColorStop(1, '#80DEEA');
            ctx.fillStyle = bgGrad;
            ctx.fillRect(-10, -10, cw + 20, ch + 20);

            state.fireTick++;
            if (state.fireTick >= state.fireInterval) {
                state.fireTick = 0;
                addSyringe();
            }

            for (var i = state.syringes.length - 1; i >= 0; i--) {
                var s = state.syringes[i];
                s.y += s.vy;
                if (s.vx) s.x += s.vx;
                if (s.y + s.h < 0 || s.x < -50 || s.x > cw + 50) {
                    state.syringes.splice(i, 1);
                    continue;
                }
                ctx.font = '20px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText('üíâ', s.x + s.w / 2, s.y + s.h / 2);

                var hitSomething = false;
                if (state.boss && hitBulletEnemy(s, state.boss)) {
                    var bossDmg = 1;
                    state.boss.hp -= bossDmg;
                    addDamageNumber(state.boss.x, state.boss.y - state.boss.r - 10, bossDmg, state.boss.hp <= state.boss.maxHp * 0.2);
                    state.syringes.splice(i, 1);
                    hitSomething = true;
                    if (state.boss.hp <= 0) {
                        addBossExplosion(state.boss.x, state.boss.y);
                        state.score += 500;
                        addGoldenGate();
                        state.boss = null;
                        state.wave++;
                        state.fireCount = Math.min(99, state.fireCount + 2);
                        document.getElementById('waveEl').textContent = state.wave;
                        document.getElementById('fireEl').textContent = state.fireCount;
                    }
                    if (hitSomething) break;
                }

                for (var j = state.enemies.length - 1; j >= 0; j--) {
                    if (hitSomething) break;
                    var e = state.enemies[j];
                    if (hitBulletEnemy(s, e)) {
                        var dmg = 1;
                        e.hp -= dmg;
                        addDamageNumber(e.x, e.y - e.r, dmg, false);
                        state.syringes.splice(i, 1);
                        hitSomething = true;
                        if (e.hp <= 0) {
                            addParticles(e.x, e.y, '#f87171', 16, 1);
                            state.enemies.splice(j, 1);
                            state.score += 15;
                            screenShake(2, 4);
                            if (state.enemies.length === 0 && !(state.wave % WAVE_BOSS_EVERY === 0 && state.wave > 0)) {
                                state.wave++;
                                document.getElementById('waveEl').textContent = state.wave;
                            }
                        }
                        break;
                    }
                }

                for (var b = 0; b < state.boxes.length && !hitSomething; b++) {
                    var box = state.boxes[b];
                    if (hitBulletBox(s, box)) {
                        box.hp--;
                        addDamageNumber(box.x + box.w / 2, box.y, 1, false);
                        state.syringes.splice(i, 1);
                        hitSomething = true;
                        if (box.hp <= 0) {
                            addParticles(box.x + box.w / 2, box.y + box.h / 2, '#fbbf24', 22, 1.3);
                            screenShake(8, 18);
                            dropWeaponUpgrade(box.x + box.w / 2, box.y + box.h / 2);
                            state.boxes.splice(b, 1);
                            state.score += 50;
                        }
                        break;
                    }
                }
            }

            var isBossWave = state.wave % WAVE_BOSS_EVERY === 0 && state.wave > 0;
            if (!state.boss && isBossWave && state.enemies.length === 0) {
                addBoss();
            }

            if (!state.boss) {
                state.spawnEnemy++;
                var spawnRate = Math.max(6, ENEMY_SPAWN_BASE - Math.floor(state.wave * 1));
                if (state.spawnEnemy >= spawnRate) {
                    state.spawnEnemy = 0;
                    if (!isBossWave) {
                        addEnemy();
                        addEnemy();
                    }
                }
            }

            var h = getPlayerHitbox();
            for (var i = state.enemies.length - 1; i >= 0; i--) {
                var e = state.enemies[i];
                e.y += e.vy;
                if (e.y - e.r > ch) {
                    state.run = false;
                    if (animationId) { cancelAnimationFrame(animationId); animationId = null; }
                    document.getElementById('finalScore').textContent = state.score;
                    document.getElementById('goScreen').classList.add('show');
                    loadRankings();
                    ctx.restore();
                    return;
                }
                var ex1 = e.x - e.r, ex2 = e.x + e.r, ey1 = e.y - e.r, ey2 = e.y + e.r;
                if (ex2 >= h.left && ex1 <= h.right && ey2 >= h.top && ey1 <= h.bottom) {
                    state.fireCount = Math.max(0, state.fireCount - 2);
                    state.enemies.splice(i, 1);
                    addParticles(e.x, e.y, '#f87171', 12, 1);
                    screenShake(4, 8);
                    document.getElementById('fireEl').textContent = state.fireCount;
                    if (state.fireCount <= 0) {
                        state.run = false;
                        if (animationId) { cancelAnimationFrame(animationId); animationId = null; }
                        document.getElementById('finalScore').textContent = state.score;
                        document.getElementById('goScreen').classList.add('show');
                        loadRankings();
                        ctx.restore();
                        return;
                    }
                }
            }
            for (var i = 0; i < state.enemies.length; i++) {
                var e = state.enemies[i];
                ctx.font = (e.r * 1.6) + 'px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(e.type, e.x, e.y);
            }

            if (state.boss) {
                var boss = state.boss;
                boss.y += boss.vy;
                if (boss.y - boss.r > ch) {
                    state.boss = null;
                    state.wave++;
                    document.getElementById('waveEl').textContent = state.wave;
                }
                if (state.boss) {
                    var barW = 80;
                    var barX = boss.x - barW / 2;
                    var barY = boss.y - boss.r - 18;
                    ctx.fillStyle = 'rgba(0,0,0,0.6)';
                    ctx.fillRect(barX - 2, barY - 2, barW + 4, 10 + 4);
                    ctx.fillStyle = '#ef4444';
                    ctx.fillRect(barX, barY, barW, 10);
                    ctx.fillStyle = '#22c55e';
                    ctx.fillRect(barX, barY, barW * (boss.hp / boss.maxHp), 10);
                    ctx.strokeStyle = '#fff';
                    ctx.lineWidth = 1;
                    ctx.strokeRect(barX, barY, barW, 10);
                    ctx.font = (boss.r * 1.4) + 'px Arial';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(boss.type, boss.x, boss.y);
                }
            }

            state.spawnBox++;
            if (state.spawnBox >= BOX_SPAWN && state.boxes.length < 2 && !state.boss) {
                state.spawnBox = 0;
                addBox();
            }

            for (var b = 0; b < state.boxes.length; b++) {
                var box = state.boxes[b];
                box.y += box.vy;
                if (box.y > ch + 50) {
                    state.boxes.splice(b, 1);
                    b--;
                    continue;
                }
                var hurt = 1 - box.hp / box.maxHp;
                ctx.globalAlpha = 0.7 + 0.3 * (1 - hurt);
                ctx.fillStyle = hurt > 0.5 ? '#b91c1c' : '#1e293b';
                ctx.fillRect(box.x, box.y, box.w, box.h);
                ctx.strokeStyle = hurt > 0.5 ? '#f87171' : '#64748b';
                ctx.lineWidth = 2;
                ctx.strokeRect(box.x, box.y, box.w, box.h);
                ctx.globalAlpha = 1;
                ctx.font = (Math.min(box.w, box.h) * 0.7) + 'px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(box.type, box.x + box.w / 2, box.y + box.h / 2);
            }

            state.spawnGate++;
            if (state.spawnGate >= GATE_SPAWN && !state.boss) {
                state.spawnGate = 0;
                addGates();
            }

            for (var k = state.gates.length - 1; k >= 0; k--) {
                var g = state.gates[k];
                g.y += g.vy;
                if (g.y > ch + GATE_H) {
                    state.gates.splice(k, 1);
                    continue;
                }
                if (g.gold) {
                    ctx.fillStyle = 'rgba(251, 191, 36, 0.95)';
                    ctx.strokeStyle = '#fcd34d';
                } else {
                    ctx.fillStyle = g.good ? 'rgba(59, 130, 246, 0.9)' : 'rgba(239, 68, 68, 0.9)';
                    ctx.strokeStyle = g.good ? '#60a5fa' : '#f87171';
                }
                ctx.fillRect(g.x, g.y, g.w, g.h);
                ctx.lineWidth = 3;
                ctx.strokeRect(g.x, g.y, g.w, g.h);
                ctx.fillStyle = '#fff';
                ctx.font = g.gold ? '14px sans-serif' : '11px sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText(g.label, g.x + g.w / 2, g.y + g.h / 2 + 4);

                if (hitPlayerGate(g)) {
                    if (g.good) {
                        if (g.gold) {
                            state.fireCount = Math.min(99, state.fireCount * 5);
                            state.fireInterval = Math.max(3, state.fireInterval - 2);
                            document.getElementById('powerUpMsg').textContent = 'üëë ÏäàÌçº Î©¥Ïó≠!';
                            document.getElementById('powerUpMsg').classList.add('gold');
                            document.getElementById('flash').classList.add('gold');
                        } else {
                            if (g.multBonus) {
                                state.fireCount = Math.min(99, state.fireCount * g.multBonus);
                            } else {
                                state.fireCount = Math.min(99, state.fireCount + (g.addBonus || 1));
                            }
                            state.fireInterval = Math.max(4, state.fireInterval - 1);
                            document.getElementById('powerUpMsg').textContent = 'Power UP!';
                            document.getElementById('powerUpMsg').classList.remove('gold');
                            document.getElementById('flash').classList.remove('gold');
                        }
                        document.getElementById('powerUpMsg').classList.add('show');
                        document.getElementById('flash').classList.add('on');
                        setTimeout(function() {
                            document.getElementById('powerUpMsg').classList.remove('show');
                            document.getElementById('flash').classList.remove('on');
                            document.getElementById('flash').classList.remove('gold');
                        }, 1200);
                    } else {
                        state.fireCount = Math.max(1, Math.floor(state.fireCount / 2));
                        state.fireInterval = Math.min(20, state.fireInterval + 1);
                    }
                    document.getElementById('fireEl').textContent = state.fireCount;
                    state.gates.splice(k, 1);
                }
            }

            for (var d = state.damageNumbers.length - 1; d >= 0; d--) {
                var dn = state.damageNumbers[d];
                dn.y += dn.vy;
                dn.life -= 0.03;
                if (dn.life <= 0) {
                    state.damageNumbers.splice(d, 1);
                    continue;
                }
                ctx.globalAlpha = dn.life;
                ctx.font = dn.crit ? 'bold 22px sans-serif' : '16px sans-serif';
                ctx.fillStyle = dn.crit ? '#c62828' : '#333333';
                ctx.textAlign = 'center';
                ctx.fillText('-' + dn.val, dn.x, dn.y);
                ctx.globalAlpha = 1;
            }

            for (var p = state.particles.length - 1; p >= 0; p--) {
                var pt = state.particles[p];
                pt.x += pt.vx;
                pt.y += pt.vy;
                pt.life -= 0.035;
                if (pt.life <= 0) {
                    state.particles.splice(p, 1);
                    continue;
                }
                ctx.globalAlpha = pt.life;
                ctx.fillStyle = pt.color;
                ctx.beginPath();
                ctx.arc(pt.x, pt.y, pt.r, 0, Math.PI * 2);
                ctx.fill();
                ctx.globalAlpha = 1;
            }

            var py = ch * (1 - PLAYER_BOTTOM_MARGIN) - state.playerH;
            var playerCx = state.px * cw;
            var playerCy = py + state.playerH / 2;
            ctx.font = 'bold 16px sans-serif';
            ctx.fillStyle = '#fbbf24';
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 2;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'bottom';
            ctx.strokeText('Lv. ' + state.fireCount, playerCx, py - 4);
            ctx.fillText('Lv. ' + state.fireCount, playerCx, py - 4);
            ctx.font = '44px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillStyle = '#333';
            ctx.fillText(Gupaengi, playerCx, playerCy);

            document.getElementById('scoreEl').textContent = state.score;
            ctx.restore();
            animationId = requestAnimationFrame(loop);
        }

        function startGame() {
            if (animationId) { cancelAnimationFrame(animationId); animationId = null; }
            state.run = true;
            state.score = 0;
            state.wave = 1;
            state.gameTime = 0;
            state.difficultyScale = 0.2;
            state.px = 0.5;
            state.fireCount = 1;
            state.fireInterval = 10;
            state.fireTick = 0;
            state.syringes = [];
            state.enemies = [];
            state.gates = [];
            state.particles = [];
            state.damageNumbers = [];
            state.boxes = [];
            state.boss = null;
            state.shakeTime = 0;
            state.spawnEnemy = 0;
            state.spawnGate = 0;
            state.spawnBox = 0;
            document.getElementById('scoreEl').textContent = '0';
            document.getElementById('waveEl').textContent = '1';
            document.getElementById('fireEl').textContent = '1';
            document.getElementById('startScreen').classList.add('hide');
            document.getElementById('goScreen').classList.remove('show');
            animationId = requestAnimationFrame(loop);
        }

        function loadRankings() {
            var el = document.getElementById('rankList');
            el.textContent = 'Î°úÎî© Ï§ë...';
            if (!GAS_URL || !GAS_URL.trim()) {
                el.innerHTML = 'Îû≠ÌÇπ ÏÑúÎ≤Ñ URL ÏóÜÏùå';
                return;
            }
            fetch(GAS_URL + '?action=getRankings&t=' + Date.now(), { method: 'GET' })
                .then(function(r) { return r.json(); })
                .then(function(d) {
                    if (d.ok && d.rankings && d.rankings.length) {
                        var html = '';
                        d.rankings.forEach(function(r, i) {
                            var medal = i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : i === 2 ? 'ü•â' : (i + 1) + 'ÏúÑ';
                            html += '<div class="rank-row">' + medal + ' ' + (r.name || 'ÏùµÎ™Ö') + ' <strong>' + r.score + '</strong></div>';
                        });
                        el.innerHTML = html;
                    } else {
                        el.innerHTML = 'ÏïÑÏßÅ Îû≠ÌÇπÏù¥ ÏóÜÏäµÎãàÎã§.';
                    }
                })
                .catch(function() {
                    el.textContent = 'Îû≠ÌÇπ Î∂àÎü¨Ïò§Í∏∞ Ïã§Ìå®';
                });
        }

        function submitRanking() {
            var name = (document.getElementById('playerName').value || '').trim();
            if (!name) {
                alert('Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•Ìï¥ Ï£ºÏÑ∏Ïöî.');
                return;
            }
            if (name.length > 10) name = name.substring(0, 10);
            if (!GAS_URL || !GAS_URL.trim()) {
                alert('ÏÑúÎ≤Ñ Ïó∞Í≤∞ Ïã§Ìå®');
                return;
            }

            var btn = document.getElementById('btnSubmit');
            btn.disabled = true;
            btn.textContent = 'Îì±Î°ù Ï§ë...';

            var body = JSON.stringify({
                action: 'saveRanking',
                payload: { name: name, score: state.score }
            });

            fetch(GAS_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                body: body,
                keepalive: true
            })
                .then(function(res) { return res.text(); })
                .then(function(text) {
                    var data;
                    try { data = JSON.parse(text); } catch (e) { data = { ok: false }; }
                    if (data.ok) {
                        alert('Îû≠ÌÇπ Îì±Î°ù ÏôÑÎ£å!');
                        loadRankings();
                        document.getElementById('playerName').value = '';
                    } else {
                        alert('Îì±Î°ù Ïã§Ìå®: ' + (data.message || 'Ïò§Î•ò'));
                    }
                })
                .catch(function(err) {
                    console.error(err);
                    alert('Îì±Î°ù Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
                })
                .then(function() {
                    btn.disabled = false;
                    btn.textContent = 'Îû≠ÌÇπ Îì±Î°ù';
                });
        }

        document.getElementById('btnStart').addEventListener('click', startGame);
        document.getElementById('btnRetry').addEventListener('click', startGame);
        document.getElementById('btnSubmit').addEventListener('click', submitRanking);
        document.getElementById('playerName').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') submitRanking();
        });

        animationId = requestAnimationFrame(loop);
    })();
    </script>
</body>
</html>
