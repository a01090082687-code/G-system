<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ë³´ê±´ ì„œë°”ì´ë²Œ: êµ¬íŒ½ì´ì˜ ì „ì„¤ | G-SYSTEM ì˜¤ë½ì‹¤</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: #1a1a2e; min-height: 100vh; display: flex; align-items: center; justify-content: center; overflow: hidden; touch-action: none; -webkit-tap-highlight-color: transparent; }
        .wrap { width: 100%; max-width: 430px; height: 100vh; max-height: 820px; position: relative; border-radius: 12px; overflow: hidden; box-shadow: 0 0 40px rgba(0,0,0,0.6); }
        #c { display: block; width: 100%; height: 100%; background: #16213e; }
        .hud { position: absolute; top: 0; left: 0; right: 0; padding: 10px 12px; display: flex; justify-content: space-between; align-items: center; pointer-events: none; z-index: 5; }
        .hud span { color: #eee; font-size: 14px; font-weight: bold; font-family: sans-serif; text-shadow: 0 1px 2px #000; }
        .start-screen { position: absolute; inset: 0; background: rgba(0,0,0,0.85); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 20; padding: 24px; pointer-events: auto; cursor: pointer; }
        .start-screen.hide { display: none; }
        .start-title { color: #fff; font-size: 22px; margin-bottom: 10px; text-align: center; }
        .start-desc { color: rgba(255,255,255,0.9); font-size: 13px; line-height: 1.6; text-align: center; margin-bottom: 20px; }
        .btn { background: linear-gradient(135deg, #e94560, #c73659); color: #fff; border: none; padding: 14px 32px; border-radius: 12px; font-size: 17px; font-weight: bold; cursor: pointer; }
        .version-info { color: rgba(255,255,255,0.6); font-size: 11px; margin-top: 12px; }
        .version-info.version-title { margin-top: 4px; margin-bottom: 6px; font-size: 13px; color: #e94560; }
        .go-screen { position: absolute; inset: 0; background: rgba(0,0,0,0.9); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 20; padding: 24px; }
        .go-screen.show { display: flex; }
        .go-title { color: #fff; font-size: 24px; margin-bottom: 8px; font-weight: bold; }
        .go-score { color: #fbbf24; font-size: 20px; margin-bottom: 20px; font-weight: bold; }
        .rank-box { width: 100%; max-width: 320px; background: rgba(255,255,255,0.95); border-radius: 12px; padding: 14px; margin-bottom: 14px; max-height: 180px; overflow-y: auto; color: #333; border: 1px solid rgba(0,0,0,0.1); font-size: 13px; }
        .rank-row { padding: 4px 0; border-bottom: 1px solid rgba(0,0,0,0.08); }
        .rank-row:last-child { border-bottom: none; }
        .go-inp { width: 100%; max-width: 320px; padding: 10px; margin-bottom: 8px; border: 2px solid rgba(0,0,0,0.2); border-radius: 8px; font-size: 15px; text-align: center; }
        .btn-submit { width: 100%; max-width: 320px; margin-bottom: 8px; }
        .xp-bar-wrap { position: absolute; top: 0; left: 0; right: 0; height: 10px; background: rgba(0,0,0,0.5); z-index: 6; pointer-events: none; }
        .xp-bar-fill { height: 100%; background: linear-gradient(90deg, #e94560, #ff6b6b); width: 0%; transition: width 0.15s; }
        .skill-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.9); z-index: 25; display: none; align-items: center; justify-content: center; padding: 16px; }
        .skill-overlay.show { display: flex; }
        .skill-overlay h2 { color: #fff; font-size: 18px; margin-bottom: 16px; position: absolute; top: 20px; left: 50%; transform: translateX(-50%); }
        .skill-cards { display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; max-width: 340px; }
        .skill-card { width: 95px; padding: 12px; background: linear-gradient(145deg, #1e293b, #334155); border: 2px solid #475569; border-radius: 10px; cursor: pointer; text-align: center; color: #fff; font-size: 26px; line-height: 1.3; transition: transform 0.12s, border-color 0.12s; }
        .skill-card:hover { transform: scale(1.05); border-color: #e94560; }
        .skill-card span { display: block; font-size: 10px; color: #94a3b8; margin-top: 4px; }
        .arcade-back { position: absolute; top: 10px; left: 10px; z-index: 30; padding: 6px 12px; background: rgba(0,0,0,0.5); color: #fff; border-radius: 8px; font-size: 12px; font-weight: bold; text-decoration: none; }
        .arcade-back:hover { background: rgba(0,0,0,0.7); color: #fff; }
    </style>
</head>
<body>
    <div class="wrap">
        <a href="index.html" class="arcade-back">â† G-SYSTEM ì˜¤ë½ì‹¤</a>
        <canvas id="c"></canvas>
        <div class="xp-bar-wrap"><div class="xp-bar-fill" id="xpBarFill"></div></div>
        <div class="hud">
            <span>Lv.<span id="levelEl">1</span> â¤ï¸<span id="healthEl">3</span> Â· <span id="scoreEl">0</span>ì´ˆ</span>
            <span id="skillIconsEl">ğŸ’‰</span>
        </div>
        <div class="skill-overlay" id="skillOverlay">
            <h2>ë ˆë²¨ì—…! ìŠ¤í‚¬ ì„ íƒ (1ê°œ)</h2>
            <div class="skill-cards" id="skillCards"></div>
        </div>
        <div class="start-screen" id="startScreen">
            <div class="start-title">ğŸ›¡ï¸ ë³´ê±´ ì„œë°”ì´ë²Œ: êµ¬íŒ½ì´ì˜ ì „ì„¤</div>
            <div class="version-info version-title">Ver 1.0 (Survival)</div>
            <div class="start-desc"><strong>ê°€ìƒ ì¡°ì´ìŠ¤í‹±</strong>(ì™¼ìª½)ìœ¼ë¡œ ì´ë™ Â· ìë™ ë°œì‚¬!<br>ì  ì²˜ì¹˜ ì‹œ <strong>XP êµ¬ìŠ¬</strong> íšë“ â†’ ë ˆë²¨ì—… ì‹œ <strong>ìŠ¤í‚¬ 3ì§€ ì„ ë‹¤</strong>(ì•ˆì „ëª¨, ì•ˆì „í™” ë“±).<br>ìµœëŒ€í•œ ì˜¤ë˜ ì‚´ì•„ë‚¨ìœ¼ì„¸ìš”.</div>
            <button type="button" class="btn" id="btnStart">ìƒì¡´ ì‹œì‘</button>
        </div>
        <div class="go-screen" id="goScreen">
            <div class="go-title">ì‚¬ë§</div>
            <div class="go-score">ìƒì¡´ ì‹œê°„: <span id="finalScore">0</span>ì´ˆ</div>
            <div class="rank-box" id="rankList">ë¡œë”© ì¤‘...</div>
            <input type="text" class="go-inp" id="playerName" placeholder="ì´ë¦„ (ìµœëŒ€ 10ì)" maxlength="10">
            <button class="btn btn-submit" id="btnSubmit">ë­í‚¹ ë“±ë¡</button>
            <button class="btn" id="btnRetry">ë‹¤ì‹œ í•˜ê¸°</button>
        </div>
    </div>
    <script>
    (function() {
        'use strict';
        var GAS_URL = 'https://script.google.com/macros/s/AKfycbxKQ7DSfpBhiBE3JOSam39bvs8argQaf0s6hQJIMpH5l5knJKVfEfcW3lpCTODjLBMkiw/exec';
        var canvas = document.getElementById('c');
        var ctx = canvas ? canvas.getContext('2d') : null;
        var cw = 0, ch = 0;
        function resize() {
            if (!canvas || !canvas.parentElement) return;
            var w = canvas.parentElement.clientWidth;
            var h = canvas.parentElement.clientHeight;
            cw = w; ch = h;
            canvas.width = w; canvas.height = h;
        }
        window.addEventListener('resize', resize);
        resize();
        if (canvas) canvas.style.pointerEvents = 'none';

        var FPS = 60;
        var animationId = null;
        var Gupaengi = 'ğŸ§';
        var PLAYER_SPEED = 3.2;
        var PLAYER_R = 18;
        var SPAWN_DIST = 380;
        var XP_PER_KILL = 2;
        var XP_MAGNET_R = 90;
        var XP_MAGNET_SPEED = 8;
        var SYR_SPEED = 10;
        var SYR_R = 8;
        var FIRE_INTERVAL_BASE = 18;
        var POISON_R = 55;
        var POISON_DMG = 0.4;
        var JOY_RADIUS = 48;
        var JOY_BASE_X = 70;
        var SKILLS_LIST = [
            { id: 'ricochet', name: 'ì•ˆì „ëª¨', icon: 'â›‘ï¸', desc: 'ì´ì•Œ 1íšŒ íŠ•ê¹€' },
            { id: 'speed', name: 'ì•ˆì „í™”', icon: 'ğŸ¥¾', desc: 'ë°œì‚¬ì†ë„ +25%' },
            { id: 'multishot', name: 'ì ˆì—°ì¥ê°‘', icon: 'ğŸ§¤', desc: 'ì´ì•Œ +1' },
            { id: 'crit', name: 'ë³´ì•ˆê²½', icon: 'ğŸ¥½', desc: 'ì¹˜ëª…íƒ€ +15%' },
            { id: 'poison', name: 'ë°©ì§„ë§ˆìŠ¤í¬', icon: 'ğŸ˜·', desc: 'ì£¼ë³€ ë…ê°€ìŠ¤' }
        ];

        var state = {
            run: false, paused: false, gameTime: 0,
            playerX: 0, playerY: 0, playerVx: 0, playerVy: 0,
            joyActive: false, joyStickX: 0, joyStickY: 0,
            health: 3, shield: 0, score: 0,
            xp: 0, xpToLevel: 10, level: 1, xpOrbs: [],
            enemies: [], syringes: [], particles: [],
            fireTick: 0, spawnTick: 0,
            difficultyScale: 0.5,
            skills: { ricochet: false, speed: false, multishot: 0, crit: false, poison: false },
            shakeX: 0, shakeY: 0, shakeT: 0
        };

        function toScreen(wx, wy) {
            return { x: wx - state.playerX + cw/2 + state.shakeX, y: wy - state.playerY + ch/2 + state.shakeY };
        }

        function addXpOrb(wx, wy, val) { state.xpOrbs.push({ x: wx, y: wy, value: val || XP_PER_KILL }); }
        function screenShake(mag) { state.shakeT = 12; state.shakeMag = mag || 4; }
        function addParticles(wx, wy, color, n) {
            n = n || 10;
            for (var i = 0; i < n; i++) {
                var a = Math.PI*2*i/n + Math.random();
                var v = 2 + Math.random()*3;
                state.particles.push({
                    wx: wx, wy: wy,
                    vx: Math.cos(a)*v, vy: Math.sin(a)*v,
                    life: 1, color: color, r: 3 + Math.random()*4
                });
            }
        }

        function showLevelUpCards() {
            var pool = SKILLS_LIST.slice();
            var chosen = [];
            for (var i = 0; i < 3 && pool.length; i++) { var idx = Math.floor(Math.random() * pool.length); chosen.push(pool.splice(idx, 1)[0]); }
            var el = document.getElementById('skillCards');
            el.innerHTML = '';
            chosen.forEach(function(s) {
                var btn = document.createElement('button');
                btn.className = 'skill-card';
                btn.innerHTML = s.icon + '<span>' + s.name + '<br>' + s.desc + '</span>';
                btn.onclick = (function(sk) { return function() {
                    applySkill(sk.id);
                    document.getElementById('skillOverlay').classList.remove('show');
                    state.paused = false;
                    updateSkillIcons();
                }; })(s);
                el.appendChild(btn);
            });
            document.getElementById('skillOverlay').classList.add('show');
        }
        function applySkill(id) {
            if (id === 'ricochet') state.skills.ricochet = true;
            if (id === 'speed') state.skills.speed = true;
            if (id === 'multishot') state.skills.multishot++;
            if (id === 'crit') state.skills.crit = true;
            if (id === 'poison') state.skills.poison = true;
            state.level++;
            state.xp = 0;
            state.xpToLevel = 8 + state.level * 5;
            document.getElementById('levelEl').textContent = state.level;
            document.getElementById('xpBarFill').style.width = '0%';
        }
        function updateSkillIcons() {
            var s = state.skills;
            var arr = [];
            if (state.shield > 0) arr.push('ğŸ›¡ï¸Ã—' + state.shield);
            if (s.ricochet) arr.push('â›‘ï¸');
            if (s.speed) arr.push('ğŸ¥¾');
            if (s.multishot) arr.push('ğŸ§¤Ã—' + s.multishot);
            if (s.crit) arr.push('ğŸ¥½');
            if (s.poison) arr.push('ğŸ˜·');
            document.getElementById('skillIconsEl').textContent = arr.length ? arr.join(' ') : 'ğŸ’‰';
        }

        function addEnemy() {
            var angle = Math.random() * Math.PI * 2;
            var ex = state.playerX + Math.cos(angle) * SPAWN_DIST;
            var ey = state.playerY + Math.sin(angle) * SPAWN_DIST;
            var type = Math.random() > 0.5 ? 'ğŸ¦ ' : 'ğŸ˜ˆ';
            var r = 14 + Math.random()*10;
            var hp = Math.max(1, Math.floor((1 + state.difficultyScale) * 2));
            state.enemies.push({
                x: ex, y: ey, r: r, hp: hp, maxHp: hp, type: type
            });
        }

        function addSyringeToward(tx, ty) {
            var count = 1 + state.skills.multishot;
            var spread = count > 1 ? 0.15 : 0;
            for (var i = 0; i < count; i++) {
                var angle = Math.atan2(ty - state.playerY, tx - state.playerX) + (i - (count-1)/2) * spread;
                var vx = Math.cos(angle) * SYR_SPEED;
                var vy = Math.sin(angle) * SYR_SPEED;
                state.syringes.push({
                    x: state.playerX, y: state.playerY,
                    vx: vx, vy: vy,
                    ricochetUsed: false
                });
            }
        }

        function clampStickToBase(tx, ty, bx, by) {
            var dx = tx - bx, dy = ty - by;
            var dist = Math.sqrt(dx*dx + dy*dy) || 1;
            if (dist <= JOY_RADIUS) return { x: tx, y: ty };
            return { x: bx + dx/dist*JOY_RADIUS, y: by + dy/dist*JOY_RADIUS };
        }

        function nearestEnemy() {
            var best = null, bestD = 1e9;
            for (var i = 0; i < state.enemies.length; i++) {
                var e = state.enemies[i];
                var d = (e.x - state.playerX)**2 + (e.y - state.playerY)**2;
                if (d < bestD && d < 350*350) { bestD = d; best = e; }
            }
            return best;
        }

        var rect = { left: 0, top: 0, width: 1, height: 1 };
        function updateRect() { var r = canvas.getBoundingClientRect(); rect.left = r.left; rect.top = r.top; rect.width = r.width; rect.height = r.height; }
        function getCanvasCoords(clientX, clientY) {
            return {
                x: (clientX - rect.left) / rect.width * cw,
                y: (clientY - rect.top) / rect.height * ch
            };
        }
        function isInJoystickZone(tx, ty) {
            var joyBaseY = ch - JOY_BASE_X;
            return tx < JOY_BASE_X + JOY_RADIUS + 40 && ty > joyBaseY - JOY_RADIUS - 40;
        }
        if (canvas) {
        canvas.addEventListener('touchstart', function(e) {
            e.preventDefault();
            if (e.touches.length) {
                updateRect();
                var p = getCanvasCoords(e.touches[0].clientX, e.touches[0].clientY);
                if (isInJoystickZone(p.x, p.y)) {
                    state.joyActive = true;
                    var joyBaseY = ch - JOY_BASE_X;
                    var c = clampStickToBase(p.x, p.y, JOY_BASE_X, joyBaseY);
                    state.joyStickX = c.x;
                    state.joyStickY = c.y;
                }
            }
        }, { passive: false });
        canvas.addEventListener('touchmove', function(e) {
            e.preventDefault();
            if (e.touches.length && state.joyActive) {
                var p = getCanvasCoords(e.touches[0].clientX, e.touches[0].clientY);
                var joyBaseY = ch - JOY_BASE_X;
                var c = clampStickToBase(p.x, p.y, JOY_BASE_X, joyBaseY);
                state.joyStickX = c.x;
                state.joyStickY = c.y;
            }
        }, { passive: false });
        canvas.addEventListener('touchend', function(e) {
            e.preventDefault();
            if (!e.touches.length) state.joyActive = false;
        });
        canvas.addEventListener('touchcancel', function() { state.joyActive = false; });
        canvas.addEventListener('mousedown', function(e) {
            updateRect();
            var p = getCanvasCoords(e.clientX, e.clientY);
            if (isInJoystickZone(p.x, p.y)) {
                state.joyActive = true;
                var joyBaseY = ch - JOY_BASE_X;
                var c = clampStickToBase(p.x, p.y, JOY_BASE_X, joyBaseY);
                state.joyStickX = c.x;
                state.joyStickY = c.y;
            }
        });
        canvas.addEventListener('mousemove', function(e) {
            if (!state.joyActive) return;
            var p = getCanvasCoords(e.clientX, e.clientY);
            var joyBaseY = ch - JOY_BASE_X;
            var c = clampStickToBase(p.x, p.y, JOY_BASE_X, joyBaseY);
            state.joyStickX = c.x;
            state.joyStickY = c.y;
        });
        canvas.addEventListener('mouseup', function() { state.joyActive = false; });
        canvas.addEventListener('mouseleave', function() { state.joyActive = false; });
        }

        function loop() {
            animationId = requestAnimationFrame(loop);
            if (!state.run) return;
            if (state.paused) return;
            if (!ctx || !canvas) return;
            if (cw <= 0 || ch <= 0) { resize(); return; }

            state.gameTime++;
            state.score = Math.floor(state.gameTime / 60);
            document.getElementById('scoreEl').textContent = state.score;

            if (state.shakeT > 0) {
                state.shakeT--;
                state.shakeX = (Math.random()-0.5)*2*state.shakeMag;
                state.shakeY = (Math.random()-0.5)*2*state.shakeMag;
                if (state.shakeT <= 0) state.shakeMag = 0;
            } else state.shakeX = state.shakeY = 0;

            var joyBaseY = ch - JOY_BASE_X;
            if (!state.joyActive) {
                state.joyStickX = JOY_BASE_X;
                state.joyStickY = joyBaseY;
            }
            var dx = 0, dy = 0;
            if (state.joyActive) {
                dx = (state.joyStickX - JOY_BASE_X) / JOY_RADIUS;
                dy = (state.joyStickY - joyBaseY) / JOY_RADIUS;
                var len = Math.sqrt(dx*dx + dy*dy);
                if (len > 1) { dx /= len; dy /= len; }
            }
            state.playerVx = dx * PLAYER_SPEED;
            state.playerVy = dy * PLAYER_SPEED;
            state.playerX += state.playerVx;
            state.playerY += state.playerVy;

            var interval = Math.max(6, FIRE_INTERVAL_BASE - (state.skills.speed ? 4 : 0));
            state.fireTick++;
            if (state.fireTick >= interval) {
                state.fireTick = 0;
                var near = nearestEnemy();
                if (near) addSyringeToward(near.x, near.y);
            }

            for (var i = state.syringes.length - 1; i >= 0; i--) {
                var s = state.syringes[i];
                s.x += s.vx;
                s.y += s.vy;
                var dist = (s.x - state.playerX)**2 + (s.y - state.playerY)**2;
                if (dist > 600*600) { state.syringes.splice(i,1); continue; }

                var hit = false;
                for (var j = state.enemies.length - 1; j >= 0; j--) {
                    var e = state.enemies[j];
                    var d = (s.x - e.x)**2 + (s.y - e.y)**2;
                    if (d < (e.r + SYR_R)*(e.r + SYR_R)) {
                        var dmg = (state.skills.crit && Math.random() < 0.15) ? 2 : 1;
                        e.hp -= dmg;
                        hit = true;
                        if (e.hp <= 0) {
                            addXpOrb(e.x, e.y);
                            addParticles(e.x, e.y, '#f87171', 8);
                            state.enemies.splice(j, 1);
                            screenShake(2);
                            if (state.skills.ricochet && !s.ricochetUsed) {
                                var next = null, nd = 1e9;
                                for (var k = 0; k < state.enemies.length; k++) {
                                    var o = state.enemies[k];
                                    var dd = (o.x - e.x)**2 + (o.y - e.y)**2;
                                    if (dd < nd && dd > 1) { nd = dd; next = o; }
                                }
                                if (next) {
                                    var ax = next.x - e.x, ay = next.y - e.y;
                                    var L = Math.sqrt(ax*ax+ay*ay)||1;
                                    state.syringes.push({ x: e.x, y: e.y, vx: (ax/L)*SYR_SPEED, vy: (ay/L)*SYR_SPEED, ricochetUsed: true });
                                }
                            }
                        }
                        state.syringes.splice(i,1);
                        break;
                    }
                }
                if (hit) break;
            }

            state.spawnTick++;
            var spawnRate = Math.max(20, 80 - Math.floor(state.gameTime/120));
            if (state.spawnTick >= spawnRate) {
                state.spawnTick = 0;
                addEnemy();
                if (state.gameTime % (60*30) < 60) addEnemy();
            }
            if (state.gameTime > 0 && state.gameTime % (60*60) === 0) state.difficultyScale = Math.min(3, state.difficultyScale + 0.2);

            for (var i = state.enemies.length - 1; i >= 0; i--) {
                var e = state.enemies[i];
                var ex = e.x - state.playerX, ey = e.y - state.playerY;
                var len = Math.sqrt(ex*ex + ey*ey) || 1;
                var sp = (1.2 + state.difficultyScale*0.3);
                e.x -= (ex/len) * sp;
                e.y -= (ey/len) * sp;

                if (state.skills.poison) {
                    var pdist = Math.sqrt(ex*ex + ey*ey);
                    if (pdist < POISON_R) {
                        e.hp -= POISON_DMG;
                        if (e.hp <= 0) {
                            addXpOrb(e.x, e.y);
                            addParticles(e.x, e.y, '#22c55e', 6);
                            state.enemies.splice(i, 1);
                        }
                    }
                }

                var touchDist = (e.x - state.playerX)**2 + (e.y - state.playerY)**2;
                if (touchDist < (PLAYER_R + e.r)*(PLAYER_R + e.r)) {
                    if (state.shield > 0) { state.shield--; updateSkillIcons(); }
                    else {
                        state.health--;
                        document.getElementById('healthEl').textContent = state.health;
                        if (state.health <= 0) {
                            state.run = false;
                            document.getElementById('finalScore').textContent = state.score;
                            document.getElementById('goScreen').classList.add('show');
                            loadRankings();
                            animationId = requestAnimationFrame(loop);
                            return;
                        }
                    }
                    state.enemies.splice(i, 1);
                    addParticles(e.x, e.y, '#ef4444', 10);
                    screenShake(8);
                }
            }

            for (var i = state.xpOrbs.length - 1; i >= 0; i--) {
                var o = state.xpOrbs[i];
                var dx = state.playerX - o.x, dy = state.playerY - o.y;
                var dist = Math.sqrt(dx*dx + dy*dy);
                if (dist < XP_MAGNET_R) {
                    if (dist < 15) {
                        state.xp += o.value;
                        state.xpOrbs.splice(i, 1);
                        if (state.xp >= state.xpToLevel) {
                            state.paused = true;
                            showLevelUpCards();
                        }
                    } else {
                        o.x += (dx/dist)*XP_MAGNET_SPEED;
                        o.y += (dy/dist)*XP_MAGNET_SPEED;
                    }
                }
            }
            document.getElementById('xpBarFill').style.width = (state.xp/state.xpToLevel*100)+'%';

            for (var i = state.particles.length - 1; i >= 0; i--) {
                var p = state.particles[i];
                p.wx += p.vx; p.wy += p.vy;
                p.life -= 0.04;
                if (p.life <= 0) state.particles.splice(i, 1);
            }

            ctx.fillStyle = '#16213e';
            ctx.fillRect(0, 0, cw, ch);
            for (var gx = -2; gx <= 2; gx++)
                for (var gy = -2; gy <= 2; gy++) {
                    var sx = (state.playerX % 80 + 80) % 80 - 80 + gx*80;
                    var sy = (state.playerY % 80 + 80) % 80 - 80 + gy*80;
                    var p = toScreen(state.playerX + sx, state.playerY + sy);
                    if (p.x >= -40 && p.x <= cw+40 && p.y >= -40 && p.y <= ch+40) {
                        ctx.strokeStyle = 'rgba(255,255,255,0.06)';
                        ctx.lineWidth = 1;
                        ctx.strokeRect(p.x, p.y, 80, 80);
                    }
                }

            state.xpOrbs.forEach(function(o) {
                var p = toScreen(o.x, o.y);
                if (p.x < -20 || p.x > cw+20 || p.y < -20 || p.y > ch+20) return;
                ctx.fillStyle = '#3b82f6';
                ctx.beginPath();
                ctx.arc(p.x, p.y, 6, 0, Math.PI*2);
                ctx.fill();
                ctx.strokeStyle = '#60a5fa';
                ctx.lineWidth = 1;
                ctx.stroke();
            });

            state.enemies.forEach(function(e) {
                var p = toScreen(e.x, e.y);
                if (p.x < -50 || p.x > cw+50 || p.y < -50 || p.y > ch+50) return;
                ctx.font = (e.r*1.8)+'px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(e.type, p.x, p.y);
            });

            state.syringes.forEach(function(s) {
                var p = toScreen(s.x, s.y);
                if (p.x < -20 || p.x > cw+20 || p.y < -20 || p.y > ch+20) return;
                ctx.font = '18px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText('ğŸ’‰', p.x, p.y);
            });

            state.particles.forEach(function(p) {
                var sp = toScreen(p.wx, p.wy);
                ctx.globalAlpha = p.life;
                ctx.fillStyle = p.color;
                ctx.beginPath();
                ctx.arc(sp.x, sp.y, p.r, 0, Math.PI*2);
                ctx.fill();
                ctx.globalAlpha = 1;
            });

            var pc = toScreen(state.playerX, state.playerY);
            ctx.font = '36px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(Gupaengi, pc.x, pc.y);

            ctx.fillStyle = 'rgba(255,255,255,0.2)';
            ctx.beginPath();
            ctx.arc(JOY_BASE_X, joyBaseY, JOY_RADIUS, 0, Math.PI*2);
            ctx.fill();
            ctx.strokeStyle = 'rgba(255,255,255,0.5)';
            ctx.lineWidth = 2;
            ctx.stroke();
            ctx.fillStyle = 'rgba(255,255,255,0.6)';
            ctx.beginPath();
            ctx.arc(state.joyStickX, state.joyStickY, 22, 0, Math.PI*2);
            ctx.fill();
            ctx.strokeStyle = 'rgba(255,255,255,0.8)';
            ctx.lineWidth = 1;
            ctx.stroke();
        }

        var startGameInProgress = false;
        function startGame() {
            if (startGameInProgress) return;
            startGameInProgress = true;
            try {
                if (!canvas || !ctx) {
                    alert('ìº”ë²„ìŠ¤ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }
                resize();
                if (cw <= 0 || ch <= 0) {
                    setTimeout(startGame, 100);
                    return;
                }
                state.run = true;
                state.paused = false;
                state.gameTime = 0;
                state.playerX = 0; state.playerY = 0;
                state.playerVx = 0; state.playerVy = 0;
                state.joyActive = false;
                state.joyStickX = JOY_BASE_X; state.joyStickY = ch - JOY_BASE_X;
                state.health = 3;
                state.shield = 0;
                state.score = 0;
                state.xp = 0;
                state.xpToLevel = 10;
                state.level = 1;
                state.xpOrbs = [];
                state.enemies = [];
                state.syringes = [];
                state.particles = [];
                state.fireTick = 0;
                state.spawnTick = 0;
                state.difficultyScale = 0.5;
                state.skills = { ricochet: false, speed: false, multishot: 0, crit: false, poison: false };
                state.shakeT = 0;
                state.shakeMag = 0;
                var healthEl = document.getElementById('healthEl');
                var scoreEl = document.getElementById('scoreEl');
                var levelEl = document.getElementById('levelEl');
                var xpBarFill = document.getElementById('xpBarFill');
                var skillOverlay = document.getElementById('skillOverlay');
                var startScreen = document.getElementById('startScreen');
                var goScreen = document.getElementById('goScreen');
                if (healthEl) healthEl.textContent = '3';
                if (scoreEl) scoreEl.textContent = '0';
                if (levelEl) levelEl.textContent = '1';
                if (xpBarFill) xpBarFill.style.width = '0%';
                if (skillOverlay) skillOverlay.classList.remove('show');
                updateSkillIcons();
                if (startScreen) startScreen.classList.add('hide');
                if (goScreen) goScreen.classList.remove('show');
                if (canvas) canvas.style.pointerEvents = 'auto';
                if (animationId != null && animationId !== undefined) {
                    cancelAnimationFrame(animationId);
                }
                animationId = requestAnimationFrame(loop);
            } catch (err) {
                state.run = false;
                var startScreen = document.getElementById('startScreen');
                if (startScreen) startScreen.classList.remove('hide');
                if (canvas) canvas.style.pointerEvents = 'none';
                alert('ê²Œì„ ì‹œì‘ ì˜¤ë¥˜: ' + (err && err.message ? err.message : 'ì•Œ ìˆ˜ ì—†ìŒ'));
            } finally {
                startGameInProgress = false;
            }
        }

        function loadRankings() {
            var el = document.getElementById('rankList');
            el.textContent = 'ë¡œë”© ì¤‘...';
            if (!GAS_URL || !GAS_URL.trim()) { el.innerHTML = 'ë­í‚¹ ì„œë²„ URL ì—†ìŒ'; return; }
            fetch(GAS_URL + '?action=getRankings&t=' + Date.now(), { method: 'GET' })
                .then(function(r) { return r.json(); })
                .then(function(d) {
                    if (d.ok && d.rankings && d.rankings.length) {
                        var html = '';
                        d.rankings.forEach(function(r, i) {
                            var medal = i===0?'ğŸ¥‡':i===1?'ğŸ¥ˆ':i===2?'ğŸ¥‰':(i+1)+'ìœ„';
                            html += '<div class="rank-row">'+medal+' '+(r.name||'ìµëª…')+' <strong>'+r.score+'</strong>ì´ˆ</div>';
                        });
                        el.innerHTML = html;
                    } else el.innerHTML = 'ì•„ì§ ë­í‚¹ì´ ì—†ìŠµë‹ˆë‹¤.';
                })
                .catch(function() { el.textContent = 'ë­í‚¹ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨'; });
        }

        function submitRanking() {
            var name = (document.getElementById('playerName').value || '').trim();
            if (!name) { alert('ì´ë¦„ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.'); return; }
            if (name.length > 10) name = name.substring(0, 10);
            if (!GAS_URL || !GAS_URL.trim()) { alert('ì„œë²„ ì—°ê²° ì‹¤íŒ¨'); return; }
            var btn = document.getElementById('btnSubmit');
            btn.disabled = true;
            btn.textContent = 'ë“±ë¡ ì¤‘...';
            fetch(GAS_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                body: JSON.stringify({ action: 'saveRanking', payload: { name: name, score: state.score } }),
                keepalive: true
            })
                .then(function(res) { return res.text(); })
                .then(function(text) {
                    var data;
                    try { data = JSON.parse(text); } catch (e) { data = { ok: false }; }
                    if (data.ok) { alert('ë­í‚¹ ë“±ë¡ ì™„ë£Œ!'); loadRankings(); document.getElementById('playerName').value = ''; }
                    else alert('ë“±ë¡ ì‹¤íŒ¨: ' + (data.message || 'ì˜¤ë¥˜'));
                })
                .catch(function() { alert('ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'); })
                .then(function() { btn.disabled = false; btn.textContent = 'ë­í‚¹ ë“±ë¡'; });
        }

        var btnStart = document.getElementById('btnStart');
        var btnRetry = document.getElementById('btnRetry');
        var startScreenEl = document.getElementById('startScreen');
        function doStartGame(e) {
            if (e) { e.preventDefault(); e.stopPropagation(); }
            requestAnimationFrame(function() { startGame(); });
        }
        function doStartGamePointer(e) { if (e) { e.preventDefault(); e.stopPropagation(); } requestAnimationFrame(function() { startGame(); }); }
        btnStart.addEventListener('click', doStartGame);
        btnStart.addEventListener('touchstart', doStartGame, { passive: false });
        btnStart.addEventListener('pointerdown', doStartGamePointer);
        startScreenEl.addEventListener('click', doStartGame);
        startScreenEl.addEventListener('touchstart', doStartGame, { passive: false });
        startScreenEl.addEventListener('pointerdown', doStartGamePointer);
        btnRetry.addEventListener('click', doStartGame);
        btnRetry.addEventListener('touchstart', doStartGame, { passive: false });
        btnRetry.addEventListener('pointerdown', doStartGamePointer);
        document.getElementById('btnSubmit').addEventListener('click', submitRanking);
        document.getElementById('playerName').addEventListener('keypress', function(e) { if (e.key === 'Enter') submitRanking(); });

        loadRankings();
        if (canvas && ctx) {
            animationId = requestAnimationFrame(loop);
        } else {
            var startScreen = document.getElementById('startScreen');
            if (startScreen) startScreen.innerHTML = '<div class="start-title" style="color:#f87171">ìº”ë²„ìŠ¤ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div><p class="version-info">ì´ ë¸Œë¼ìš°ì €ì—ì„œëŠ” ê²Œì„ì„ ì‹¤í–‰í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>';
        }
    })();
    </script>
</body>
</html>
